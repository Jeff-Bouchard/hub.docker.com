<!DOCTYPE html>
<html lang="fr" data-ness-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Menu NESS V3</title>
  <style>
    :root {
      --bg-primary: #020409;
      --bg-panel: #080b13;
      --bg-panel-alt: #0d111a;
      --bg-chip: rgba(255, 255, 255, 0.05);
      --border-color: #232838;
      --text-main: #f5f8ff;
      --text-muted: #9aa5c5;
      --accent: #f78f1e;
      --accent-2: #4fc1ff;
      --accent-3: #ce60ff;
      --danger: #ff5470;
      --success: #5ce0a0;
      --shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      font-family: "IBM Plex Sans", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      line-height: 1.5;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #101326, var(--bg-primary));
      color: var(--text-main);
      padding: 28px clamp(18px, 4vw, 60px) 48px;
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 600;
    }

    a {
      color: var(--accent-2);
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .hero {
      background: linear-gradient(130deg, rgba(11, 14, 25, 0.9), rgba(5, 7, 14, 0.8));
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 28px;
      box-shadow: var(--shadow);
    }

    .hero__top {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      justify-content: space-between;
    }

    .logo-ascii {
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size: 0.9rem;
      letter-spacing: 0.04em;
      white-space: pre;
      color: var(--accent-2);
      margin: 0;
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .badge {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 0.88rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-chip);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .badge strong {
      font-size: 0.95rem;
      letter-spacing: 0.02em;
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
      margin-top: 24px;
    }

    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card h3 {
      font-size: 1.05rem;
      color: var(--accent-2);
    }

    .card small {
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    label span {
      display: block;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: var(--bg-panel-alt);
      color: var(--text-main);
      padding: 10px 14px;
      font-size: 1rem;
      font-family: inherit;
    }

    button {
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      border-radius: 12px;
      padding: 11px 18px;
      color: #04050a;
      background: linear-gradient(135deg, var(--accent), #ffbf5a);
      transition: transform 120ms ease, box-shadow 120ms ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(247, 143, 30, 0.35);
    }

    .button-secondary {
      background: linear-gradient(135deg, var(--accent-2), #7fe1ff);
      color: #010409;
    }

    .button-danger {
      background: linear-gradient(135deg, var(--danger), #ff7f97);
      color: #02030b;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .pill-group button {
      flex: 1 1 140px;
      border-radius: 999px;
      background: var(--bg-chip);
      color: var(--text-main);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-align: center;
      padding: 10px 14px;
    }

    .pill-group button.active {
      background: var(--accent-3);
      color: #04050a;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.12);
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }

    .profile-card {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 18px;
      background: var(--bg-panel-alt);
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: border 120ms ease, transform 120ms ease;
    }

    .profile-card.active {
      border-color: var(--accent-2);
      box-shadow: 0 8px 18px rgba(79, 193, 255, 0.25);
      transform: translateY(-1px);
    }

    .profile-card h4 {
      font-size: 1.02rem;
      margin: 0;
    }

    .profile-card p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.88rem;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .action-card {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .action-card h4 {
      margin: 0;
      font-size: 1rem;
      color: var(--accent);
    }

    .action-card p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .action-card footer {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .fleet-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .fleet-table th,
    .fleet-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      text-align: left;
    }

    .fleet-table th {
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.76rem;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    form.dns-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    form.dns-form button[type="submit"] {
      grid-column: 1 / -1;
      justify-self: flex-start;
    }

    #actionLog {
      background: #010308;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 16px;
      min-height: 140px;
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size: 0.9rem;
      color: #96ffa4;
      overflow-x: auto;
      white-space: pre-wrap;
    }

    .log-info { color: #8bd8ff; }
    .log-error { color: #ff9bb5; }
    .log-success { color: #9af7c1; }

    .api-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .api-row input {
      flex: 1 1 240px;
    }

    @media (max-width: 640px) {
      .hero__top {
        flex-direction: column;
        align-items: flex-start;
      }
      .badge {
        width: 100%;
        justify-content: space-between;
      }
      .pill-group button {
        flex: 1 1 100%;
      }
    }

    @media (min-width: 1100px) {
      .app-shell {
        max-width: 1400px;
        display: grid;
        grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.8fr) minmax(0, 1.4fr);
        grid-template-rows: auto minmax(0, 1fr);
        grid-template-areas:
          "hero hero hero"
          "labels operations log";
        gap: 24px;
        align-items: flex-start;
      }

      .hero {
        grid-area: hero;
      }

      #labelsSection {
        grid-area: labels;
      }

      #operationsSection {
        grid-area: operations;
      }

      #logSection {
        grid-area: log;
      }
    }
  </style>
</head>
<body>
  <main class="app-shell">
    <section class="hero">
      <div class="hero__top">
        <pre class="logo-ascii"> _   _                     _   _                   _   _            
| \ | |                   | \ | |                 | \ | |           
|  \| | ___  ___ ___ _ __ |  \| | ___  _ __ ___   |  \| | _____   __
| . ` |/ _ \/ __/ _ \ '_ \| . ` |/ _ \| '_ ` _ \  | . ` |/ _ \ \ / /
| |\  |  __/ (_|  __/ | | | |\  | (_) | | | | | | | |\  |  __/\ V / 
\_| \_/\___|\___\___|_| |_|_| \_/\___/|_| |_| |_| \_| \_/\___| \_/  </pre>
        <div class="badges">
          <div class="badge" id="realityBadge"><strong>Réalité</strong><span data-role="reality-text">Hybride → EmerDNS d'abord</span></div>
          <div class="badge" id="profileBadge"><strong>Profil</strong><span data-role="profile-text">Pi 3 Essentiels</span></div>
          <div class="badge"><strong>Prêt MCP</strong><span>Profils Serveur + Client disponibles</span></div>
        </div>
      </div>

      <div class="control-grid" style="margin-top: 26px;">
        <div class="card stack">
          <h3>Point de terminaison API</h3>
          <small>Pointez cette UI vers l'API Ness qui relaie les actions du menu.</small>
          <div class="api-row">
            <input type="url" id="apiBase" placeholder="https://noeud.exemple.org/api/menu" />
            <button type="button" class="button-secondary" id="saveEndpoint">Définir</button>
          </div>
          <small id="endpointStatus" class="log-info">Aucun endpoint configuré. Les actions restent locales (simulation).</small>
        </div>
        <div class="card">
          <h3>Mode Réalité / DNS</h3>
          <small>Sélectionnez la vision du monde appliquée aux agents et résolveurs DNS.</small>
          <div class="pill-group" id="realityButtons">
            <button type="button" data-mode="icann">ICANN uniquement</button>
            <button type="button" data-mode="hybrid">Hybride</button>
            <button type="button" data-mode="emerdns">EmerDNS uniquement</button>
          </div>
        </div>
        <div class="card">
          <h3>Profil de déploiement</h3>
          <small>Ensemble matériel / services que "Démarrer le stack" va orchestrer.</small>
          <div class="profile-grid" id="profileCards"></div>
        </div>
      </div>
    </section>

    <section class="card stack" id="labelsSection">
      <h3>Libellés de Réalité</h3>
      <small>Personnalisez chaque mode. Sauvegardé en localStorage et réutilisé par les clients MCP.</small>
      <form class="dns-form" id="dnsForm">
        <label>
          <span>ICANN uniquement</span>
          <input type="text" name="icann" required />
        </label>
        <label>
          <span>Hybride</span>
          <input type="text" name="hybrid" required />
        </label>
        <label>
          <span>EmerDNS uniquement</span>
          <input type="text" name="emerdns" required />
        </label>
        <button type="submit">Enregistrer les libellés</button>
      </form>
    </section>

    <section class="card stack">
      <h3>Console d'opérations</h3>
      <small>Port HTML du Menu V3. Les boutons envoient des intentions vers votre endpoint d'automatisation.</small>
      <div class="actions-grid">
        <article class="action-card">
          <h4>Construire les images</h4>
          <p>Lance les builds Docker (multi-arch si supporté).</p>
          <footer>
            <button type="button" class="button-secondary" data-action="build-all" data-payload='{"script":"build-all.sh"}'>build-all.sh</button>
            <button type="button" class="button-secondary" data-action="build-multiarch" data-payload='{"script":"build-multiarch.sh"}'>build-multiarch.sh</button>
          </footer>
          <div class="stack" style="margin-top: 10px;">
            <small>Image unique (équivalent au build par image du CLI) :</small>
            <div class="api-row">
              <select id="singleImageSelect">
                <option value="">Choisir une image…</option>
              </select>
              <button type="button" class="button-secondary" id="buildSingleImageBtn">Construire la sélection</button>
            </div>
          </div>
        </article>
        <article class="action-card">
          <h4>Stack</h4>
          <p>Démarre ou arrête uniquement les services du profil sélectionné.</p>
          <footer>
            <button type="button" data-action="start-stack">Démarrer</button>
            <button type="button" class="button-secondary" data-action="stop-stack">Arrêter</button>
          </footer>
        </article>
        <article class="action-card">
          <h4>Statut du stack</h4>
          <p>Inspecte l'état docker compose (équivalent option 4 du menu CLI).</p>
          <footer>
            <button type="button" data-action="stack-status">Afficher le statut</button>
          </footer>
        </article>
        <article class="action-card">
          <h4>Logs</h4>
          <p>Stream des logs de tous les services.</p>
          <footer>
            <button type="button" data-action="tail-logs">Suivre les logs</button>
          </footer>
        </article>
        <article class="action-card">
          <h4>Audit d'entropie</h4>
          <p>Vérifie que les générateurs UHE (RC4OK + UHEPRNG) sont actifs.</p>
          <footer>
            <button type="button" data-action="check-entropy">Vérifier l'entropie</button>
          </footer>
        </article>
        <article class="action-card">
          <h4>Supprimer l'état local</h4>
          <p>Stoppe les conteneurs, supprime volumes et cache. À utiliser avec précaution.</p>
          <footer>
            <button type="button" class="button-danger" data-action="nuke-local">Tout supprimer localement</button>
          </footer>
        </article>
        <article class="action-card">
          <h4>Récompenses de flotte (bientôt)</h4>
          <p>Identité Skywire par nœud et comptabilité des récompenses depuis les contrôleurs.</p>
          <table class="fleet-table">
            <thead>
              <tr>
                <th>Nœud</th>
                <th>Pubkey Skywire</th>
                <th>Dernière vue</th>
                <th>Récompenses Skywire</th>
                <th>Récompenses Privateness</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5">Bientôt – câblé dans Menu V4 vers le contrôleur et l'indexeur de récompenses.</td>
              </tr>
            </tbody>
          </table>
        </article>
        <article class="action-card">
          <h4>Synchroniser les libellés</h4>
          <p>Propage les changements de libellés de Réalité (équivalent option 8).</p>
          <footer>
            <button type="button" data-action="sync-labels">Synchroniser</button>
          </footer>
        </article>
        <article class="action-card">
          <h4>Quitter la session</h4>
          <p>Signale aux agents distants que cette UI opérateur se ferme.</p>
          <footer>
            <button type="button" data-action="exit">Quitter</button>
          </footer>
        </article>
      </div>
    </section>

    <section class="card stack">
      <h3>Journal d'actions</h3>
      <small>Les réponses de l'endpoint d'automatisation apparaissent ici.</small>
      <pre id="actionLog">Prêt. Configurez un endpoint ou restez en mode local.</pre>
    </section>
  </main>

  <script>
    const STORAGE_KEYS = {
      dnsLabels: "ness.dnsLabels",
      dnsMode: "ness.dnsMode",
      profile: "ness.profile",
      endpoint: "ness.apiEndpoint"
    };

    const DEFAULT_LABELS = {
      icann: "ICANN uniquement (refuser EmerDNS)",
      hybrid: "Hybride (EmerDNS d'abord, retour ICANN)",
      emerdns: "EmerDNS uniquement (refuser ICANN)"
    };

    const PROFILES = {
      pi3: {
        title: "Pi 3 Essentiels",
        desc: "Emercoin, Privateness, DNS, Skywire, Outils",
      },
      skyminer: {
        title: "Skyminer",
        desc: "Emercoin, Privateness, DNS, Outils — sans conteneur Skywire",
      },
      full: {
        title: "Nœud complet",
        desc: "Emercoin, Yggdrasil, I2P-Yggdrasil, Skywire, AmneziaWG, Skywire-AmneziaWG, DNS, pyuheprng, Privateness, Privatenumer, Privatenesstools",
      },
      "mcp-server": {
        title: "Suite Serveur MCP",
        desc: "Démons MCP, rendez-vous Magic Wormhole",
      },
      "mcp-client": {
        title: "Suite Client MCP",
        desc: "Applications, aides QR, client Magic Wormhole",
      }
    };

    const SINGLE_IMAGES = [
      "emercoin-core",
      "yggdrasil",
      "dns-reverse-proxy",
      "skywire",
      "privateness",
      "ness-blockchain",
      "pyuheprng",
      "privatenumer",
      "privatenesstools",
      "pyuheprng-privatenesstools",
      "ipfs",
      "i2p-yggdrasil",
      "amneziawg",
      "skywire-amneziawg",
      "amnezia-exit",
      "ness-unified",
    ];

    const state = {
      dnsMode: localStorage.getItem(STORAGE_KEYS.dnsMode) || "hybrid",
      dnsLabels: JSON.parse(localStorage.getItem(STORAGE_KEYS.dnsLabels) || "null") || { ...DEFAULT_LABELS },
      profile: localStorage.getItem(STORAGE_KEYS.profile) || "pi3",
      endpoint: localStorage.getItem(STORAGE_KEYS.endpoint) || ""
    };

    const refs = {
      realityButtons: document.getElementById("realityButtons"),
      dnsForm: document.getElementById("dnsForm"),
      profileCards: document.getElementById("profileCards"),
      realityText: document.querySelector('[data-role="reality-text"]'),
      profileText: document.querySelector('[data-role="profile-text"]'),
      actionLog: document.getElementById("actionLog"),
      apiBase: document.getElementById("apiBase"),
      endpointStatus: document.getElementById("endpointStatus"),
      saveEndpoint: document.getElementById("saveEndpoint"),
      singleImageSelect: document.getElementById("singleImageSelect"),
      buildSingleImageBtn: document.getElementById("buildSingleImageBtn"),
    };

    refs.apiBase.value = state.endpoint;
    updateEndpointStatus();

    function persist() {
      localStorage.setItem(STORAGE_KEYS.dnsMode, state.dnsMode);
      localStorage.setItem(STORAGE_KEYS.profile, state.profile);
      localStorage.setItem(STORAGE_KEYS.dnsLabels, JSON.stringify(state.dnsLabels));
      localStorage.setItem(STORAGE_KEYS.endpoint, state.endpoint);
    }

    function renderRealityButtons() {
      const buttons = refs.realityButtons.querySelectorAll("button[data-mode]");
      buttons.forEach(btn => {
        const mode = btn.dataset.mode;
        btn.textContent = state.dnsLabels[mode];
        btn.classList.toggle("active", mode === state.dnsMode);
      });
      refs.realityText.textContent = `${state.dnsLabels[state.dnsMode]}`;
    }

    function renderProfileCards() {
      refs.profileCards.innerHTML = "";
      Object.entries(PROFILES).forEach(([key, meta]) => {
        const card = document.createElement("button");
        card.type = "button";
        card.className = "profile-card";
        if (state.profile === key) card.classList.add("active");
        card.dataset.profile = key;
        card.innerHTML = `<h4>${meta.title}</h4><p>${meta.desc}</p>`;
        card.addEventListener("click", () => {
          state.profile = key;
          refs.profileText.textContent = meta.title;
          persist();
          renderProfileCards();
        });
        refs.profileCards.appendChild(card);
      });
      refs.profileText.textContent = PROFILES[state.profile]?.title || state.profile;
    }

    function populateDnsForm() {
      refs.dnsForm.icann.value = state.dnsLabels.icann;
      refs.dnsForm.hybrid.value = state.dnsLabels.hybrid;
      refs.dnsForm.emerdns.value = state.dnsLabels.emerdns;
    }

    function populateSingleImageSelect() {
      if (!refs.singleImageSelect) return;
      refs.singleImageSelect.querySelectorAll("option:not(:first-child)").forEach(opt => opt.remove());
      SINGLE_IMAGES.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        refs.singleImageSelect.appendChild(opt);
      });
    }

    refs.realityButtons.addEventListener("click", (event) => {
      const btn = event.target.closest("button[data-mode]");
      if (!btn) return;
      state.dnsMode = btn.dataset.mode;
      persist();
      renderRealityButtons();
      log(`Mode Réalité basculé sur ${state.dnsLabels[state.dnsMode]}`, "success");
    });

    refs.dnsForm.addEventListener("submit", (event) => {
      event.preventDefault();
      state.dnsLabels = {
        icann: refs.dnsForm.icann.value.trim(),
        hybrid: refs.dnsForm.hybrid.value.trim(),
        emerdns: refs.dnsForm.emerdns.value.trim()
      };
      persist();
      renderRealityButtons();
      log("Libellés de Réalité mis à jour.", "success");
    });

    refs.saveEndpoint.addEventListener("click", () => {
      state.endpoint = refs.apiBase.value.trim();
      persist();
      updateEndpointStatus();
      log(state.endpoint ? `Endpoint défini sur ${state.endpoint}` : "Endpoint effacé. Actions locales uniquement.", "info");
    });

    if (refs.buildSingleImageBtn) {
      refs.buildSingleImageBtn.addEventListener("click", () => {
        const image = refs.singleImageSelect?.value || "";
        if (!image) {
          log("Choisissez d'abord une image à construire.", "error");
          return;
        }
        callMenuAction("build-image", { image });
      });
    }

    function updateEndpointStatus() {
      if (state.endpoint) {
        refs.endpointStatus.textContent = `Envoi des POST vers ${state.endpoint}`;
        refs.endpointStatus.className = "log-success";
      } else {
        refs.endpointStatus.textContent = "Aucun endpoint configuré. Actions en mode local (simulation).";
        refs.endpointStatus.className = "log-info";
      }
    }

    function log(message, level = "info") {
      const timestamp = new Date().toISOString();
      const line = `[${timestamp}] ${message}`;
      const span = document.createElement("span");
      span.textContent = `${line}\n`;
      span.className = `log-${level}`;
      refs.actionLog.appendChild(span);
      refs.actionLog.scrollTop = refs.actionLog.scrollHeight;
    }

    async function callMenuAction(action, payload = {}) {
      const body = {
        action,
        profile: state.profile,
        dns_mode: state.dnsMode,
        labels: state.dnsLabels,
        ...payload
      };

      log(`Dispatch action ${action} avec payload ${JSON.stringify(payload)}`, "info");

      if (!state.endpoint) {
        log("Endpoint manquant : configurez un endpoint API pour exécuter l'action.", "error");
        return;
      }

      try {
        const response = await fetch(state.endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(body)
        });

        const text = await response.text();
        let parsed;
        try {
          parsed = JSON.parse(text);
        } catch (err) {
          parsed = text;
        }

        if (!response.ok) {
          throw new Error(typeof parsed === "string" ? parsed : JSON.stringify(parsed));
        }

        log(typeof parsed === "string" ? parsed : JSON.stringify(parsed, null, 2), "success");
      } catch (error) {
        log(`Erreur: ${error.message}`, "error");
      }
    }

    document.querySelectorAll("[data-action]").forEach((button) => {
      button.addEventListener("click", () => {
        let payload = {};
        const raw = button.dataset.payload;
        if (raw) {
          try {
            payload = JSON.parse(raw);
          } catch (err) {
            log(`Payload JSON invalide: ${err.message}`, "error");
          }
        }
        callMenuAction(button.dataset.action, payload);
      });
    });

    renderRealityButtons();
    renderProfileCards();
    populateDnsForm();
    populateSingleImageSelect();
  </script>
</body>
</html>
