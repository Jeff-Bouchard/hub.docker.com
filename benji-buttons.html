<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Benji Buttons</title>
  <style>
    body { background: #101c2a; color: #e0e0e0; font-family: 'Fira Sans', Arial, sans-serif; margin: 0; }
    .container { max-width: 700px; margin: 40px auto; background: #171f2e; border-radius: 12px; box-shadow: 0 0 12px #0008; padding: 2em 2.5em; text-align: center; }
    h1 { color: #6ec6ff; margin-bottom: 0.2em; }
    p.subtitle { color: #9ab6d6; margin-top: 0; margin-bottom: 2em; }
    .buttons { display: flex; flex-direction: column; gap: 1em; }
    .btn {
      display: inline-block;
      padding: 0.9em 1.4em;
      border-radius: 8px;
      border: none;
      font-size: 1.1em;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #6ec6ff, #2196f3);
      color: #101c2a;
      text-decoration: none;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.2s ease-in-out;
      box-shadow: 0 0 0 1px #28334a, 0 10px 25px rgba(0,0,0,0.45);
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 14px 30px rgba(0,0,0,0.55); }
    .btn:active { transform: translateY(0); box-shadow: 0 8px 20px rgba(0,0,0,0.45); background: #2196f3; }
    .btn.secondary { background: linear-gradient(135deg, #ffb74d, #ff9800); color: #101c2a; }
    .btn.tertiary { background: linear-gradient(135deg, #ab47bc, #8e24aa); color: #f8f5ff; }
    .footer { margin-top: 2em; text-align: center; color: #6ec6ff; font-size: 0.95em; }
    .result-wrapper {
      margin-top: 2em;
      position: relative;
    }
    .result {
      text-align: left;
      background: #101624;
      border-radius: 8px;
      border: 1px solid #28334a;
      padding: 1em 1.2em;
      font-family: "Fira Code", monospace;
      font-size: 0.95em;
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .copy-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      padding: 0.2em 0.6em;
      font-size: 0.8em;
      border-radius: 4px;
      border: none;
      background: #2b85d3;
      color: #f5faff;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: #47a0ec;
    }
    .copy-btn:active {
      background: #1f6ea8;
    }
    .result-actions {
      position: absolute;
      right: 8px;
      bottom: 6px;
      display: flex;
      gap: 0.4em;
      font-size: 0.8em;
    }
    .action-btn {
      padding: 0.15em 0.6em;
      border-radius: 4px;
      border: none;
      background: #263146;
      color: #f5faff;
      cursor: pointer;
    }
    .action-btn:hover {
      background: #36425a;
    }
    .action-btn:active {
      background: #1b2435;
    }
    @media (max-width: 800px) { .container { padding: 1.5em 1em; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Privateness Persona</h1>
    <p class="subtitle">Fetch EmerNVS records via emerapi.info GraphQL: ness:wallet, ness:hub and ness:id.</p>
    <div class="buttons">
      <button id="benji-wallet" class="btn">Quickstart &mdash; Wallet (ness:wallet)</button>
      <button id="benji-hub" class="btn secondary">Containers &mdash; Hub (ness:hub)</button>
      <button id="benji-id" class="btn tertiary">Bedrock Identity Creation Wizard HTML code&mdash; ID (ness:id)</button>
    </div>
    <div id="benji-result-wrapper" class="result-wrapper" style="display:none;">
      <button id="benji-copy" class="copy-btn">COPY</button>
      <div id="benji-result" class="result"></div>
      <div class="result-actions">
        <button id="benji-save" class="action-btn">save as file</button>
        <button id="benji-open-html" class="action-btn">open as html</button>
      </div>
    </div>
    <div class="footer">Privateness.Network &copy; 2025</div>
  </div>
  <script>
    const API_URL = 'https://emerapi.info/graphql';
    let currentNvsName = null;

    function formatQuery(name) {
      const data = JSON.stringify({ name });
      // query { callwalletfunction(method:"name_show", data:"{ \"name\": \"ness:wallet\" }") { answer } }
      return `query { callwalletfunction(method: "name_show", data: ${JSON.stringify(data)}) { answer } }`;
    }

    async function fetchNvs(name) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: formatQuery(name) })
      });
      const json = await res.json();
      if (json.errors) {
        throw new Error(JSON.stringify(json.errors, null, 2));
      }
      const answer = json.data && json.data.callwalletfunction && json.data.callwalletfunction.answer;
      console.log('Answer type:', typeof answer, answer);
      
      // If answer is a string, parse it first
      let parsedAnswer = answer;
      if (typeof answer === 'string') {
        parsedAnswer = JSON.parse(answer);
      }
      
      if (!parsedAnswer || !parsedAnswer.result) {
        return JSON.stringify(parsedAnswer, null, 2);
      }
      const result = parsedAnswer.result;
      // Prefer the EmerNVS value field and parse it like emercoin-value.py
      if (typeof result.value === 'string' && result.value.trim() !== '') {
        // The value field contains the actual command string
        return result.value.trim();
      }
      // Fallback: show full result JSON
      return JSON.stringify(result, null, 2);
    }

    function showResult(title, text) {
      const wrapper = document.getElementById('benji-result-wrapper');
      const box = document.getElementById('benji-result');
      if (!box) return;
      if (wrapper) {
        wrapper.style.display = '';
      }
      // Show ONLY the command text, no title or description
      box.textContent = text;
      box.dataset.copyPayload = text;
    }

    function wireBenji(id, nvsName, label) {
      const btn = document.getElementById(id);
      if (!btn) return;
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        const orig = btn.textContent;
        btn.textContent = `${orig} â€¦`;
        try {
          const result = await fetchNvs(nvsName);
          currentNvsName = nvsName;
          showResult('', result);
        } catch (e) {
          showResult('', String(e));
        } finally {
          btn.disabled = false;
          btn.textContent = orig;
        }
      });
    }

    function getResultPayload() {
      const box = document.getElementById('benji-result');
      if (!box) return '';
      return (box.dataset && box.dataset.copyPayload) || box.textContent || '';
    }

    function setupCopy() {
      const btn = document.getElementById('benji-copy');
      if (!btn || !navigator.clipboard) return;
      btn.addEventListener('click', async () => {
        const payload = getResultPayload();
        if (!payload) return;
        try {
          await navigator.clipboard.writeText(payload.trim());
          const original = btn.textContent;
          btn.textContent = 'COPIED';
          setTimeout(() => {
            btn.textContent = original;
          }, 1200);
        } catch (e) {
          console.error(e);
        }
      });
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function setupResultActions() {
      const saveBtn = document.getElementById('benji-save');
      const openBtn = document.getElementById('benji-open-html');
      if (!saveBtn && !openBtn) return;

      if (saveBtn) {
        saveBtn.addEventListener('click', () => {
          const payload = getResultPayload();
          if (!payload) return;
          const trimmed = payload.trim();
          const isHtml = /^\s*</.test(trimmed);

          const baseRaw = currentNvsName || 'benji-output';
          const baseName = baseRaw.replace(/:/g, '-');
          const ua = navigator.userAgent || '';
          const isWindows = /Windows/i.test(ua);
          const ext = isHtml ? '.html' : (isWindows ? '.bat' : '.sh');
          const filename = baseName + ext;

          const blob = new Blob([trimmed + '\n'], { type: 'text/plain;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

      if (openBtn) {
        openBtn.addEventListener('click', () => {
          const payload = getResultPayload();
          if (!payload) return;
          const trimmed = payload.trim();
          const win = window.open('', '_blank');
          if (!win) return;
          win.document.open();
          if (/^\s*</.test(trimmed)) {
            win.document.write(trimmed);
          } else {
            win.document.write('<!DOCTYPE html><html><head><meta charset="utf-8"><title>Benji Output</title></head><body><pre>');
            win.document.write(escapeHtml(trimmed));
            win.document.write('</pre></body></html>');
          }
          win.document.close();
        });
      }
    }

    wireBenji('benji-wallet', 'ness:wallet', 'EmerNVS Wallet');
    wireBenji('benji-hub', 'ness:hub', 'EmerNVS Hub');
    wireBenji('benji-id', 'ness:id', 'EmerNVS ID');
    setupCopy();
    setupResultActions();
  </script>
</body>
</html>
