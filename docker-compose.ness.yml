

services:
  emercoin-core:
    image: nessnetwork/emercoin-core:latest
    container_name: emercoin-core
    volumes:
      - emercoin-data:/data
    ports:
      - "6661:6661"
      - "6662:6662"
    restart: unless-stopped
    healthcheck:
      # Use the same datadir as the daemon, and give it generous time to start/sync
      test: ["CMD", "emercoin-cli", "-datadir=/data", "getblockchaininfo"]
      interval: 60s
      timeout: 20s
      retries: 10
      start_period: 300s
    networks:
      - ness-network

  pyuheprng-privatenesstools:
    image: nessnetwork/pyuheprng-privatenesstools:latest
    container_name: pyuheprng-privatenesstools
    privileged: true
    devices:
      - /dev/random
    volumes:
      - /dev:/dev
    ports:
      - "5000:5000"    # pyuheprng
      - "8888:8888"    # privatenesstools
    restart: unless-stopped
    environment:
      - EMERCOIN_HOST=emercoin-core
      - EMERCOIN_PORT=6662
      - EMERCOIN_USER=${EMERCOIN_RPC_USER:-rpcuser}
      - EMERCOIN_PASS=${EMERCOIN_RPC_PASS:-rpcpassword}
      - MIN_ENTROPY_RATE=1000
      - BLOCK_ON_LOW_ENTROPY=true
    depends_on:
      emercoin-core:
        condition: service_healthy
    networks:
      - ness-network

  dns-reverse-proxy:
    image: nessnetwork/dns-reverse-proxy:latest
    container_name: dns-reverse-proxy
    ports:
      - "53:53/udp"
      - "53:53/tcp"
      - "8053:8053"
    environment:
      - EMERCOIN_HOST=emercoin-core
      - EMERCOIN_PORT=6662
      - EMERCOIN_USER=${EMERCOIN_RPC_USER:-rpcuser}
      - EMERCOIN_PASS=${EMERCOIN_RPC_PASS:-rpcpassword}
      - DNS_NVS_KEY=ness:dns-reverse-proxy-config
    restart: unless-stopped
    depends_on:
      - emercoin-core
    networks:
      - ness-network

  privateness:
    image: nessnetwork/privateness:latest
    container_name: privateness
    ports:
      - "6006:6006"  # P2P
      - "6660:6660"  # RPC
    restart: unless-stopped
    depends_on:
      - emercoin-core
      - dns-reverse-proxy
      - pyuheprng-privatenesstools
    networks:
      - ness-network

  ipfs:
    image: nessnetwork/ipfs:latest
    container_name: ipfs
    volumes:
      - ipfs-data:/data/ipfs
    ports:
      - "4001:4001"     # P2P swarm
      - "5001:5001"     # API
      - "8080:8080"     # Gateway (conflicts with privateness, change if needed)
      - "8081:8081"     # WebUI
    environment:
      - IPFS_STORAGE_MAX=50GB
    restart: unless-stopped
    networks:
      - ness-network

volumes:
  emercoin-data:
  ipfs-data:

networks:
  ness-network:
    driver: bridge
